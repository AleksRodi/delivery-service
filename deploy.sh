#!/bin/bash

set -e

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
PROJECT_DIR="/root/delivery-service"          # –ü—É—Ç—å –¥–æ –ø—Ä–æ–µ–∫—Ç–∞ (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –ø—É—Å—Ç–∞!)
REPO_URL="git@github.com:your/repo.git"       # SSH-—Å—Å—ã–ª–∫–∞ –Ω–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
SSH_KEY="/root/.ssh/id_ed25519"               # –ü—É—Ç—å –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É SSH-–∫–ª—é—á—É

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH-–∫–ª—é—á
if [ ! -f "$SSH_KEY" ]; then
  echo "‚ùå SSH-–∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω: $SSH_KEY"
  exit 1
fi

# 2. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SSH-–∫–ª—é—á–∞
export GIT_SSH_COMMAND="ssh -i $SSH_KEY -o IdentitiesOnly=yes"

# 3. –ö–ª–æ–Ω–∏—Ä—É–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç
if [ -d "$PROJECT_DIR/.git" ]; then
  echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
  cd "$PROJECT_DIR"
  git pull
else
  echo "‚è¨ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
  rm -rf "$PROJECT_DIR" 2>/dev/null || true  # –û—á–∏—â–∞–µ–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  mkdir -p "$PROJECT_DIR"
  git clone "$REPO_URL" "$PROJECT_DIR"
  cd "$PROJECT_DIR"
fi

# 4. –ó–∞–ø—É—Å–∫–∞–µ–º Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üê≥ –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose down || true  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
docker compose pull
docker compose build --no-cache  # –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –±–µ–∑ –∫–µ—à–∞ (–Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏)
docker compose up -d

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:"
docker ps
